# Narrative Forge – 下一步计划与架构落地

## 目标基调
- **UI 观感：** 编辑体验对标 Figma（分栏、画布、工具条、可拖拽节点）。
- **内核理念：** 以 Unity / Godot 的“场景 + 节点 + 资源”思路，形成渲染、输入、资源、状态同步的可插拔模块。
- **AI 赋能：** Gemini 提供对话生成、场景描述扩写，后续扩展到节点自动布局与分支生成。

## 当前仓库现状（v0.1）
- Vite + React 前端单页，包含侧边栏/画布/检查器的基础编辑界面。现有数据为本地 `INITIAL_STORY` 示例，并已接好 Gemini 文本生成服务（缺少 API_KEY 配置）。
- 类型定义集中在 `types.ts`，引擎/协议层尚未拆分。

## 优先交付路线图
1. **工程化与模块骨架**
   - 拆分前端视图与“引擎”接口：在 `src/` 或 `packages/` 内新建 `engine/` 目录，暴露渲染、场景树、命令总线接口（TypeScript 接口 + stub 实现）。
   - 引入状态管理（如 Zustand/Recoil 或 Redux Toolkit）替换深层 `useState`，为协同和撤销/重做做铺垫。

2. **场景/节点系统 MVP**
   - 定义 Node 类型扩展：Location、Dialogue、Branch、Jump 的统一基类与序列化格式。
   - 画布交互：选择/多选、拖拽、缩放、对齐线、吸附；节点创建/删除命令。
   - 资源面板：角色、场景资源列表与占位数据管理。

3. **前端-内核协议**
   - 事件/命令模型：`EditorCommand`（创建、更新、删除、连线）、`EngineEvent`（渲染完成、校验结果）。
   - 数据通道：JSON 序列化 + 版本号；考虑未来 WebWorker / WebAssembly 的隔离执行。

4. **AI 能力深化**
   - 文字侧：对话批量变体、分支节点自动生成、场景描述扩写（已有 `GeminiService` 可复用）。
   - 结构侧：基于提示的节点自动布局、剧情大纲转场景树（需要新服务封装）。

5. **体验优化与可视化**
   - 画布：网格/对齐、缩略图小地图、选择框、快捷键（V 选择、空格平移）。
   - Inspector：分区面板（Transform、内容、AI 建议、元数据），支持多选属性编辑。
   - 导出/预览：生成 JSON 剧情文件并提供简单运行时预览。

## 近期具体任务（建议迭代）
- **迭代 1：**
  - 在 `src/engine/` 建立接口与空实现（SceneGraph、Renderer、CommandBus）。
  - 抽离画布与面板组件到独立文件，保持 App.tsx 精简。
  - 补充 `.env.example`，声明 `GEMINI_API_KEY`。

- **迭代 2：**
  - 引入状态管理库，封装选中、拖拽、撤销/重做逻辑。
  - 为节点新增“连线”与“分支跳转”占位数据结构，画布支持连接线可视化（可先用 SVG）。

- **迭代 3：**
  - AI 场景描述接口落地到 UI：为 Location 节点增加“AI 扩写”按钮。
  - 提供导出 JSON / 导入 JSON 的工具栏操作，便于后端或运行时消费。

## 配置与运行提示
- 环境变量：在 `.env.local` 或 `.env` 设置 `GEMINI_API_KEY` 后再运行 `npm run dev`/`npm run build`。
- 后续计划：添加 ESLint/Prettier、CI 工作流，以及单元测试覆盖核心节点/命令逻辑。
